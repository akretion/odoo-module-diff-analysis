PR: https://github.com/odoo/odoo/pull/104741

From: 75a105f46a13f75eb56a0de80faa2a6e146730aa
From: Gorash
Date: 2023-08-18 07:49:11

Structural Changes: 1.8
Total Changes: 40

[REF] base/all: Update modifier syntax: remove 'states' from fields

These changes are made as a result of simplifying attrs and 'states' in
views. However, they should have remained in a separate commit. When
applying the script making the xml changes (used later for the migration
script), the script checked the definition of the python fields in order
to convert the information into a python expression. Therefore, this
commit is not applied when the script is applied to xml changes.

During this attribute deletion pre-existing errors were found. Part of
the code was using the boolean values of 'states' and another part of
the code was not. The behavior could therefore be different (in cases
where readonly on the field had the same value as the ballan in
'states').

Following the deletion of 'states' and without the application of the
view migration, the js tests (tower) were no longer functional. Tests
using the Form view suffered the same effect. There are few tests that
had to be adapted, including two tests in business accounting (updated
by the accounting team). A test for column_invisible did not work. Test
checking if the test system triggers an error if we try to write on an
invisible field. It turns out that Form was testing on the value of
invisible but not taking into account if the column was invisible. The
test system fix is applied separately because there were a lot of tests
that were incorrect.

Part-of: odoo/odoo#104741

================================= pseudo patch: =================================

--- a/addons/mrp/models/mrp_production.py
+++ b/addons/mrp/models/mrp_production.py
@@ -55,15 +55,13 @@ class MrpProduction(models.Model):
     backorder_sequence = fields.Integer("Backorder Sequence", default=0, copy=False, help="Backorder sequence, if equals to 0 means there is not related backorder")
     origin = fields.Char(
         'Source', copy=False,
-        states={'done': [('readonly', True)], 'cancel': [('readonly', True)]},
         help="Reference of the document that generated this production order request.")
 
     product_id = fields.Many2one(
         'product.product', 'Product',
         domain="[('type', 'in', ['product', 'consu'])]",
         compute='_compute_product_id', store=True, copy=True, precompute=True,
-        readonly=True, required=True, check_company=True,
-        states={'draft': [('readonly', False)]})
+        readonly=False, required=True, check_company=True)
     product_variant_attributes = fields.Many2many('product.template.attribute.value', related='product_id.product_template_attribute_value_ids')
     workcenter_id = fields.Many2one('mrp.workcenter', store=False)  # Only used for search in view_mrp_production_filter
     product_tracking = fields.Selection(related='product_id.tracking')
@@ -163,7 +161,7 @@ class MrpProduction(models.Model):
     move_raw_ids = fields.One2many(
         'stock.move', 'raw_material_production_id', 'Components',
         compute='_compute_move_raw_ids', store=True, readonly=False,
-        copy=False, states={'done': [('readonly', True)], 'cancel': [('readonly', True)]},
+        copy=False,
         domain=[('scrapped', '=', False)])
     move_finished_ids = fields.One2many(
         'stock.move', 'production_id', 'Finished Products', readonly=False,
@@ -187,7 +185,6 @@ class MrpProduction(models.Model):
         help='Technical field to check when we can reserve quantities')
     user_id = fields.Many2one(
         'res.users', 'Responsible', default=lambda self: self.env.user,
-        states={'done': [('readonly', True)], 'cancel': [('readonly', True)]},
         domain=lambda self: [('groups_id', 'in', self.env.ref('mrp.group_mrp_user').id)])
     company_id = fields.Many2one(
         'res.company', 'Company', default=lambda self: self.env.company,

--- a/addons/mrp/models/mrp_unbuild.py
+++ b/addons/mrp/models/mrp_unbuild.py
@@ -19,18 +19,18 @@ class MrpUnbuild(models.Model):
     product_id = fields.Many2one(
         'product.product', 'Product', check_company=True,
         domain="[('type', 'in', ['product', 'consu'])]",
-        required=True, states={'done': [('readonly', True)]})
+        required=True)
     company_id = fields.Many2one(
         'res.company', 'Company',
         default=lambda s: s.env.company,
-        required=True, index=True, states={'done': [('readonly', True)]})
+        required=True, index=True)
     product_qty = fields.Float(
         'Quantity', default=1.0,
-        required=True, states={'done': [('readonly', True)]})
+        required=True)
     product_uom_id = fields.Many2one(
         'uom.uom', 'Unit of Measure',
         compute='_compute_product_uom_id', store=True, readonly=False, precompute=True,
-        required=True, states={'done': [('readonly', True)]})
+        required=True)
     bom_id = fields.Many2one(
         'mrp.bom', 'Bill of Material',
         domain="""[
@@ -43,13 +43,12 @@ class MrpUnbuild(models.Model):
         '|',
             ('company_id', '=', company_id),
             ('company_id', '=', False)
-        ]
-""",
-        states={'done': [('readonly', True)]}, check_company=True)
+        ]""",
+        check_company=True)
     mo_id = fields.Many2one(
         'mrp.production', 'Manufacturing Order',
         domain="[('state', '=', 'done'), ('product_id', '=?', product_id), ('bom_id', '=?', bom_id)]",
-        states={'done': [('readonly', True)]}, check_company=True)
+        check_company=True)
     mo_bom_id = fields.Many2one('mrp.bom', 'Bill of Material used on the Production Order', related='mo_id.bom_id')
     lot_id = fields.Many2one(
         'stock.lot', 'Lot/Serial Number',
@@ -60,13 +59,13 @@ class MrpUnbuild(models.Model):
         domain="[('usage','=','internal')]",
         check_company=True,
         compute='_compute_location_id', store=True, readonly=False, precompute=True,
-        required=True, states={'done': [('readonly', True)]}, help="Location where the product you want to unbuild is.")
+        required=True, help="Location where the product you want to unbuild is.")
     location_dest_id = fields.Many2one(
         'stock.location', 'Destination Location',
         domain="[('usage','=','internal')]",
         check_company=True,
         compute='_compute_location_id', store=True, readonly=False, precompute=True,
-        required=True, states={'done': [('readonly', True)]}, help="Location where you want to send the components resulting from the unbuild order.")
+        required=True, help="Location where you want to send the components resulting from the unbuild order.")
     consume_line_ids = fields.One2many(
         'stock.move', 'consume_unbuild_id', readonly=True,
         string='Consumed Disassembly Lines')

--- a/addons/mrp/models/mrp_workorder.py
+++ b/addons/mrp/models/mrp_workorder.py
@@ -22,12 +22,10 @@ class MrpWorkorder(models.Model):
         return workcenters.browse(workcenter_ids)
 
     name = fields.Char(
-        'Work Order', required=True,
-        states={'done': [('readonly', True)], 'cancel': [('readonly', True)]})
+        'Work Order', required=True)
     barcode = fields.Char(compute='_compute_barcode', store=True)
     workcenter_id = fields.Many2one(
         'mrp.workcenter', 'Work Center', required=True,
-        states={'done': [('readonly', True)], 'cancel': [('readonly', True)], 'progress': [('readonly', True)]},
         group_expand='_read_group_workcenter_id', check_company=True)
     working_state = fields.Selection(
         string='Workcenter Status', related='workcenter_id.working_state') # technical: used in views only
@@ -73,17 +71,16 @@ class MrpWorkorder(models.Model):
         'Start',
         compute='_compute_dates',
         inverse='_set_dates',
-        states={'done': [('readonly', True)], 'cancel': [('readonly', True)]},
+        readonly=False,
         store=True, copy=False)
     date_finished = fields.Datetime(
         'End',
         compute='_compute_dates',
         inverse='_set_dates',
-        states={'done': [('readonly', True)], 'cancel': [('readonly', True)]},
+        readonly=False,
         store=True, copy=False)
     duration_expected = fields.Float(
         'Expected Duration', digits=(16, 2), compute='_compute_duration_expected',
-        states={'done': [('readonly', True)], 'cancel': [('readonly', True)]},
         readonly=False, store=True) # in minutes
     duration = fields.Float(
         'Real Duration', compute='_compute_duration', inverse='_set_duration',

--- a/addons/mrp/models/stock_scrap.py
+++ b/addons/mrp/models/stock_scrap.py
@@ -8,17 +8,16 @@ class StockScrap(models.Model):
 
     production_id = fields.Many2one(
         'mrp.production', 'Manufacturing Order',
-        states={'done': [('readonly', True)]}, check_company=True)
+        check_company=True)
     workorder_id = fields.Many2one(
         'mrp.workorder', 'Work Order',
-        states={'done': [('readonly', True)]},
         check_company=True) # Not to restrict or prefer quants, but informative
     product_is_kit = fields.Boolean(related='product_id.is_kits')
     product_template = fields.Many2one(related='product_id.product_tmpl_id')
     bom_id = fields.Many2one(
         'mrp.bom', 'Kit',
         domain="[('type', '=', 'phantom'), '|', ('product_id', '=', product_id), '&', ('product_id', '=', False), ('product_tmpl_id', '=', product_template)]",
-        states={'done': [('readonly', True)]}, check_company=True)
+        check_company=True)
 
     @api.onchange('workorder_id')
     def _onchange_workorder_id(self):
