PR: https://github.com/odoo/odoo/pull/75967

From: 68ea460f3f2f9989ff813014c30095b4db7e7d63
From: Xavier-Do
Date: 2021-09-06 12:03:27

Structural Changes: 3
Total Changes: 60

[IMP] profiling, base: add enable profiling wizard

When using profiling on a fresh test database, it can be tedious to
access settings to enable the feature. This commit adds a wizard to help
enabling profiling without accessing the settings when trying to
activate profiling on a administrator session.

closes odoo/odoo#75967

Signed-off-by: Xavier Doll√© (xdo) <xdo@odoo.com>

================================= pseudo patch: =================================

--- a/odoo/addons/base/models/ir_profile.py
+++ b/odoo/addons/base/models/ir_profile.py
@@ -6,6 +6,8 @@ import datetime
 import json
 import logging
 
+from dateutil.relativedelta import relativedelta
+
 from odoo import fields, models, api, _
 from odoo.exceptions import UserError
 from odoo.http import request
@@ -86,7 +88,15 @@ class IrProfile(models.Model):
             _logger.info("User %s started profiling", self.env.user.name)
             if not limit:
                 request.session.profile_session = None
-                raise UserError(_('Profiling is not enabled on this database'))
+                if self.env.user._is_system():
+                    return {
+                            'type': 'ir.actions.act_window',
+                            'view_mode': 'form',
+                            'res_model': 'base.enable.profiling.wizard',
+                            'target': 'new',
+                            'views': [[False, 'form']],
+                        }
+                raise UserError(_('Profiling is not enabled on this database. Please contact an administrator.'))
             if not request.session.profile_session:
                 request.session.profile_session = make_session(self.env.user.name)
                 request.session.profile_expiration = limit
@@ -108,3 +118,26 @@ class IrProfile(models.Model):
             'collectors': request.session.profile_collectors,
             'params': request.session.profile_params,
         }
+
+
+class EnableProfilingWizard(models.TransientModel):
+    _name = 'base.enable.profiling.wizard'
+    _description = "Enable profiling for some time"
+
+    duration = fields.Selection([
+        ('minutes_5', "5 Minutes"),
+        ('hours_1', "1 Hour"),
+        ('days_1', "1 Day"),
+        ('months_1', "1 Month"),
+    ], string="Enable profiling for")
+    expiration = fields.Datetime("Enable profiling until", compute='_compute_expiration', store=True, readonly=False)
+
+    @api.depends('duration')
+    def _compute_expiration(self):
+        for record in self:
+            unit, quantity = (record.duration or 'days_0').split('_')
+            record.expiration = fields.Datetime.now() + relativedelta(**{unit: int(quantity)})
+
+    def submit(self):
+        self.env['ir.config_parameter'].set_param('base.profiling_enabled_until', self.expiration)
+        return False

--- a/odoo/addons/base/security/ir.model.access.csv
+++ b/odoo/addons/base/security/ir.model.access.csv
@@ -122,3 +122,4 @@
 "access_base_partner_merge_line","access.base.partner.merge.line","model_base_partner_merge_line","base.group_partner_manager",1,1,1,0
 "access_base_partner_merge_automatic_wizard","access.base.partner.merge.automatic.wizard","model_base_partner_merge_automatic_wizard","base.group_partner_manager",1,1,1,0
 "access_ir_profile","ir_profile","model_ir_profile","group_system",1,1,1,1
+"access_base_enable_profiling_wizard","access.base.enable.profiling.wizard","model_base_enable_profiling_wizard","group_system",1,1,1,0

--- a/odoo/addons/base/views/ir_profile_views.xml
+++ b/odoo/addons/base/views/ir_profile_views.xml
@@ -43,6 +43,30 @@
         </field>
     </record>
 
+    <record id="enable_profiling_wizard" model="ir.ui.view">
+        <field name="name">Enable profiling</field>
+        <field name="model">base.enable.profiling.wizard</field>
+        <field name="arch" type="xml">
+            <form string="Enable profiling">
+                <div class="alert alert-warning" role="alert">
+                    <h3>Profiling is currently disabled.</h3>
+                    Profiling is a developer feature that should be used with caution on production database.
+                    It may add some load on the server, and potentially make it less responsive.
+                    Enabling the profiling here allows all users to activate profiling on their session.
+                    Profiling can be disabled at any moment in the settings.
+                </div>
+                <group>
+                    <field name="duration"/>
+                    <field name="expiration"/>
+                </group>
+                <footer>
+                    <button string="Cancel" class="btn-secondary" special="cancel" data-hotkey="z"/>
+                    <button string="Enable profiling" type="object" name="submit" class="btn btn-primary"/>
+                </footer>
+            </form>
+        </field>
+    </record>
+
     <record id="action_menu_ir_profile" model="ir.actions.act_window">
         <field name="name">Ir profile</field>
         <field name="type">ir.actions.act_window</field>
