PR: https://github.com/odoo/odoo/pull/

From: 232d66069a2dab0653b7c851c3c3cda8fe7d7f63
From: Yannick Tivisse
Date: 2021-12-02 11:12:03

Structural Changes: 6
Total Changes: 13

[IMP] sale: Make some field precomputed

================================= pseudo patch: =================================

--- a/addons/sale_timesheet/models/account.py
+++ b/addons/sale_timesheet/models/account.py
@@ -25,7 +25,9 @@ class AccountAnalyticLine(models.Model):
             compute='_compute_timesheet_invoice_type', compute_sudo=True, store=True, readonly=True)
     commercial_partner_id = fields.Many2one('res.partner', compute="_compute_commercial_partner")
     timesheet_invoice_id = fields.Many2one('account.move', string="Invoice", readonly=True, copy=False, help="Invoice created from the timesheet")
-    so_line = fields.Many2one(compute="_compute_so_line", store=True, readonly=False, domain="[('is_service', '=', True), ('is_expense', '=', False), ('state', 'in', ['sale', 'done']), ('order_partner_id', 'child_of', commercial_partner_id)]")
+    so_line = fields.Many2one(
+        compute="_compute_so_line", store=True, readonly=False, precompute=True,
+        domain="[('is_service', '=', True), ('is_expense', '=', False), ('state', 'in', ['sale', 'done']), ('order_partner_id', 'child_of', commercial_partner_id)]")
     # we needed to store it only in order to be able to groupby in the portal
     order_id = fields.Many2one(related='so_line.order_id', store=True, readonly=False)
     is_so_line_edited = fields.Boolean("Is Sales Order Item Manually Edited")

--- a/addons/sale_timesheet/models/project.py
+++ b/addons/sale_timesheet/models/project.py
@@ -53,7 +53,8 @@ class Project(models.Model):
         compute="_compute_timesheet_product_id", store=True, readonly=False,
         default=_default_timesheet_product_id)
     warning_employee_rate = fields.Boolean(compute='_compute_warning_employee_rate')
-    partner_id = fields.Many2one(compute='_compute_partner_id', store=True, readonly=False)
+    partner_id = fields.Many2one(
+        compute='_compute_partner_id', store=True, readonly=False, precompute=True)
 
     @api.depends('sale_line_id', 'sale_line_employee_ids', 'allow_billable')
     def _compute_pricing_type(self):
@@ -482,7 +483,7 @@ class ProjectTask(models.Model):
         super(ProjectTask, billable_tasks)._compute_sale_order_id()
         (self - billable_tasks).sale_order_id = False
 
-    @api.depends('commercial_partner_id', 'sale_line_id.order_partner_id.commercial_partner_id', 'parent_id.sale_line_id', 'project_id.sale_line_id', 'allow_billable')
+    @api.depends('commercial_partner_id', 'sale_line_id.order_partner_id', 'parent_id.sale_line_id', 'project_id.sale_line_id', 'allow_billable')
     def _compute_sale_line(self):
         billable_tasks = self.filtered('allow_billable')
         (self - billable_tasks).update({'sale_line_id': False})

--- a/addons/sale_timesheet/models/project_sale_line_employee_map.py
+++ b/addons/sale_timesheet/models/project_sale_line_employee_map.py
@@ -10,7 +10,9 @@ class ProjectProductEmployeeMap(models.Model):
 
     project_id = fields.Many2one('project.project', "Project", required=True)
     employee_id = fields.Many2one('hr.employee', "Employee", required=True)
-    sale_line_id = fields.Many2one('sale.order.line', "Sales Order Item", compute="_compute_sale_line_id", store=True, readonly=False,
+    sale_line_id = fields.Many2one(
+        'sale.order.line', "Sales Order Item",
+        compute="_compute_sale_line_id", store=True, readonly=False, precompute=True,
         domain="""[
             ('is_service', '=', True),
             ('is_expense', '=', False),
