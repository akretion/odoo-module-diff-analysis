PR: https://github.com/odoo/odoo/pull/

From: 0c4bae5b5e86ae05a73316ae83861de6733c3d2d
From: Victor Feyens
Date: 2019-09-30 16:20:40

Structural Changes: 8
Total Changes: 18

[IMP] sale*: multi company checks

================================= pseudo patch: =================================

--- a/addons/sale_management/models/sale_order.py
+++ b/addons/sale_management/models/sale_order.py
@@ -12,7 +12,7 @@ class SaleOrder(models.Model):
 
     sale_order_template_id = fields.Many2one(
         'sale.order.template', 'Quotation Template',
-        readonly=True,
+        readonly=True, check_company=True,
         states={'draft': [('readonly', False)], 'sent': [('readonly', False)]},
         domain="['|', ('company_id', '=', False), ('company_id', '=', company_id)]")
     sale_order_option_ids = fields.One2many(

--- a/addons/sale_management/models/sale_order_template.py
+++ b/addons/sale_management/models/sale_order_template.py
@@ -61,10 +61,14 @@ class SaleOrderTemplateLine(models.Model):
 
     sequence = fields.Integer('Sequence', help="Gives the sequence order when displaying a list of sale quote lines.",
         default=10)
-    sale_order_template_id = fields.Many2one('sale.order.template', 'Quotation Template Reference', required=True,
-        ondelete='cascade', index=True)
+    sale_order_template_id = fields.Many2one(
+        'sale.order.template', 'Quotation Template Reference',
+        required=True, ondelete='cascade', index=True)
+    company_id = fields.Many2one('res.company', related='sale_order_template_id.company_id', store=True, index=True)
     name = fields.Text('Description', required=True, translate=True)
-    product_id = fields.Many2one('product.product', 'Product', domain=[('sale_ok', '=', True)])
+    product_id = fields.Many2one(
+        'product.product', 'Product', check_company=True,
+        domain=[('sale_ok', '=', True)])
     price_unit = fields.Float('Unit Price', required=True, digits='Product Price')
     discount = fields.Float('Discount (%)', digits='Discount', default=0.0)
     product_uom_qty = fields.Float('Quantity', required=True, digits='Product UoS', default=1)
@@ -116,11 +120,15 @@ class SaleOrderTemplateLine(models.Model):
 class SaleOrderTemplateOption(models.Model):
     _name = "sale.order.template.option"
     _description = "Quotation Template Option"
+    _check_company_auto = True
 
     sale_order_template_id = fields.Many2one('sale.order.template', 'Quotation Template Reference', ondelete='cascade',
         index=True, required=True)
+    company_id = fields.Many2one('res.company', related='sale_order_template_id.company_id', store=True, index=True)
     name = fields.Text('Description', required=True, translate=True)
-    product_id = fields.Many2one('product.product', 'Product', domain=[('sale_ok', '=', True)], required=True)
+    product_id = fields.Many2one(
+        'product.product', 'Product', domain=[('sale_ok', '=', True)],
+        required=True, check_company=True)
     price_unit = fields.Float('Unit Price', required=True, digits='Product Price')
     discount = fields.Float('Discount (%)', digits='Discount')
     uom_id = fields.Many2one('uom.uom', 'Unit of Measure ', required=True, domain="[('category_id', '=', product_uom_category_id)]")
