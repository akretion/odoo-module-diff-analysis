PR: https://github.com/odoo/odoo/pull/85220

From: d2b68d186e4ee61aecd6e69aec77d4518d1ce22f
From: RÃ©my Voet (ryv)
Date: 2022-03-03 11:03:55

Structural Changes: 6
Total Changes: 12

[FIX] website: remove force prefetch for translate fields

Issue
-----
When website is installed, the rendering of template uses a side effect
of the ORM cache (cache shared between sudoed env vs non-sudoed env) and
the fields prefetching feature to work correctly.

The `self.visibility` in (`_handle_visibility`, website/ir_ui_view.py)
is done in sudo mode, then it will fetch all prefetchable fields and put
them in the cache (that will be read in non-sudo mode in the render of
the template).  Another example of issue related to this:
https://github.com/odoo/odoo/pull/83341.

Because of this, the fields of mixin `website.seo.metadata` were forced
to be prefetchable (the default for translate is to be not prefetchable
since https://github.com/odoo/odoo/pull/82896), which causes a useless
LEFT JOIN on "ir_translation" in most of business flow.

Fix
---
Remove the `prefetch=True` on mixin fields, and add a extra read to fill
the cache in case of website rendering.  It also allows to read these
fields at the same time.

Part-of: odoo/odoo#85220

================================= pseudo patch: =================================

--- a/addons/website/models/ir_ui_view.py
+++ b/addons/website/models/ir_ui_view.py
@@ -389,7 +389,7 @@ class View(models.Model):
                     (request.website.is_public_user() or self.id not in request.session.get('views_unlock', [])):
                 pwd = request.params.get('visibility_password')
                 if pwd and self.env.user._crypt_context().verify(
-                        pwd, self.sudo().visibility_password):
+                        pwd, self.visibility_password):
                     request.session.setdefault('views_unlock', list()).append(self.id)
                 else:
                     error = werkzeug.exceptions.Forbidden('website_visibility_password_required')
@@ -469,6 +469,10 @@ class View(models.Model):
                 editable=editable,
             ))
 
+            # fetch non-prefetchable fields of the mixin SeoMetadata, as they
+            # will be read later in non-sudo mode
+            self.sudo().read(['website_meta_title', 'website_meta_description', 'website_meta_keywords'])
+
         return qcontext
 
     @api.model

--- a/addons/website/models/mixins.py
+++ b/addons/website/models/mixins.py
@@ -23,9 +23,9 @@ class SeoMetadata(models.AbstractModel):
     _description = 'SEO metadata'
 
     is_seo_optimized = fields.Boolean("SEO optimized", compute='_compute_is_seo_optimized')
-    website_meta_title = fields.Char("Website meta title", translate=True, prefetch=True)
-    website_meta_description = fields.Text("Website meta description", translate=True, prefetch=True)
-    website_meta_keywords = fields.Char("Website meta keywords", translate=True, prefetch=True)
+    website_meta_title = fields.Char("Website meta title", translate=True)
+    website_meta_description = fields.Text("Website meta description", translate=True)
+    website_meta_keywords = fields.Char("Website meta keywords", translate=True)
     website_meta_og_img = fields.Char("Website opengraph image")
     seo_name = fields.Char("Seo name", translate=True, prefetch=True)
 
