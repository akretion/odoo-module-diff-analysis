PR: https://github.com/odoo/odoo/pull/126679

From: c31032f415092425722245415dc017ca92dcac74
From: Adrien Minne (adrm)
Date: 2023-06-29 16:20:37

Structural Changes: 3
Total Changes: 67

[IMP] spreadsheet: update o_spreadsheet to latest version

https://github.com/odoo/o-spreadsheet/commit/7d15d3c7 [REL] 16.4.0-alpha.6
https://github.com/odoo/o-spreadsheet/commit/56f3b593 [IMP] spreadsheet: add locale handling Task: 3222401
https://github.com/odoo/o-spreadsheet/commit/5aec70d4 [IMP] cell: store date string as value + format Task: 3222401
https://github.com/odoo/o-spreadsheet/commit/eeaf0083 [IMP] icons: add display header icon
https://github.com/odoo/o-spreadsheet/commit/3f1e970c [FIX] SelectionInput: fix position of exclamation mark icon Task: 3355063
https://github.com/odoo/o-spreadsheet/commit/a46bf04e [FIX] LineBarPieConfigPanel: charts data series invalid input Task: 3355063

closes odoo/odoo#126679

Related: odoo/enterprise#43291
Signed-off-by: Lucas Lef√®vre (lul) <lul@odoo.com>

================================= pseudo patch: =================================

--- a/addons/spreadsheet/models/__init__.py
+++ b/addons/spreadsheet/models/__init__.py
@@ -2,4 +2,5 @@
 
 from . import res_currency
 from . import res_currency_rate
+from . import res_lang
 from . import spreadsheet_mixin

--- a/None
+++ b/addons/spreadsheet/models/res_lang.py
@@ -0,0 +1,32 @@
+# Part of Odoo. See LICENSE file for full copyright and licensing details.
+
+from odoo import api, models
+
+from odoo.addons.spreadsheet.utils import (
+    strftime_format_to_spreadsheet_date_format,
+    strftime_format_to_spreadsheet_time_format,
+)
+
+
+class Lang(models.Model):
+    _inherit = "res.lang"
+
+    @api.model
+    def get_locales_for_spreadsheet(self):
+        """Return the list of locales available for a spreadsheet."""
+        langs = self.with_context(active_test=False).search([])
+
+        spreadsheet_locales = [lang._odoo_lang_to_spreadsheet_locale() for lang in langs]
+        return spreadsheet_locales
+
+    def _odoo_lang_to_spreadsheet_locale(self):
+        """Convert an odoo lang to a spreadsheet locale."""
+        return {
+            "name": self.name,
+            "code": self.code,
+            "thousandsSeparator": self.thousands_sep,
+            "decimalSeparator": self.decimal_point,
+            "dateFormat": strftime_format_to_spreadsheet_date_format(self.date_format),
+            "timeFormat": strftime_format_to_spreadsheet_time_format(self.time_format),
+            "formulaArgSeparator": ";" if self.decimal_point == "," else ",",
+        }

--- a/addons/spreadsheet/models/spreadsheet_mixin.py
+++ b/addons/spreadsheet/models/spreadsheet_mixin.py
@@ -4,7 +4,6 @@
 import base64
 import json
 from odoo import api, fields, models, _
-from odoo.addons.spreadsheet.utils import empty_spreadsheet_data_base64
 from odoo.exceptions import ValidationError
 
 class SpreadsheetMixin(models.AbstractModel):
@@ -12,7 +11,11 @@ class SpreadsheetMixin(models.AbstractModel):
     _description = "Spreadsheet mixin"
     _auto = False
 
-    spreadsheet_binary_data = fields.Binary(required=True, string="Spreadsheet file", default=empty_spreadsheet_data_base64())
+    spreadsheet_binary_data = fields.Binary(
+        required=True,
+        string="Spreadsheet file",
+        default=lambda self: self._empty_spreadsheet_data_base64(),
+    )
     spreadsheet_data = fields.Text(compute='_compute_spreadsheet_data', inverse='_inverse_spreadsheet_data')
     thumbnail = fields.Binary()
 
@@ -39,3 +42,30 @@ class SpreadsheetMixin(models.AbstractModel):
                 json.loads(data_str)
             except:
                 raise ValidationError(_('Invalid JSON Data'))
+
+    def _empty_spreadsheet_data_base64(self):
+        """Create an empty spreadsheet workbook.
+        Encoded as base64
+        """
+        data = json.dumps(self._empty_spreadsheet_data())
+        return base64.b64encode(data.encode())
+
+    def _empty_spreadsheet_data(self):
+        """Create an empty spreadsheet workbook.
+        The sheet name should be the same for all users to allow consistent references
+        in formulas. It is translated for the user creating the spreadsheet.
+        """
+        lang = self.env["res.lang"]._lang_get(self.env.user.lang)
+        locale = lang._odoo_lang_to_spreadsheet_locale()
+        return {
+            "version": 1,
+            "sheets": [
+                {
+                    "id": "sheet1",
+                    "name": _("Sheet1"),
+                }
+            ],
+            "settings": {
+                "locale": locale,
+            }
+        }
