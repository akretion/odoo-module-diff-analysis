PR: https://github.com/odoo/odoo/pull/91240

From: ac67e6a8df2819e88240c981e60a59f5f74ff6e3
From: Pierre-Yves Dufays
Date: 2022-09-01 13:32:44

Structural Changes: 3
Total Changes: 34

[IMP] base,{fetch}mail,l10n_it_edi,{test}mass_mailing:prevent using arch server

Prevent archiving in-use mail servers by displaying an error message that
lists where it is still used, allowing to easily identify what need to be
updated before being able to archive the mail server.

Additionally,
- prevent the use of archived server as a fall-safe
- when duplicating a mailing with an archived mail server, replace mail
server by the default one

Detailed explanation:
1. A check has been added that raise an exception when trying to connect to the
smtp server or send an email when the server is archived.
With that solution,
- testing the connection of an archived server displays an error telling that
an archived server cannot be used.
- if a mail is still sent with an archived server, mail are in error :
"Connection failed (outgoing mail server problem)"
This fail-safe ensures that no mail will be sent through an archived mail server
and that the user will get some feedback about it.

The same fail-safe for the incoming mail server has been added.

Notes:
- the connection will outlive the archiving of a mail server still allowing
to send email through the archived server until the connection is closed. But
connection are not kept for long so this shouldn't be a problem.
- it cannot be tested because the connect method return immediately in test
mode.

2. When a mail server is archived, an user error is raised if it is in-use.
The implementation relies on each module to override the method
"_active_usages_compute" in "ir_mail_server" to complete the list with
user-friendly message describing the active elements that could send mail
through the mail server. This has been implemented for:
- l10n_it_edi: server used to send e-invoice
- mail: optional server configured for template
- mass_mailing:
-- default mail server
-- active server configured for mailing

Mail server are referenced in other elements but are not active anymore, it is
just for temporary or history purpose. Those references doesnâ€™t prevent the
archiving of the mail server:
- mail_message
- wizard survey_invite and compose_message
- res_config_settings

Task-2821516

closes odoo/odoo#91240

Signed-off-by: Thibault Delavallee (tde) <tde@openerp.com>

================================= pseudo patch: =================================

--- a/addons/mail/models/__init__.py
+++ b/addons/mail/models/__init__.py
@@ -48,6 +48,7 @@ from . import ir_actions_server
 from . import ir_attachment
 from . import ir_config_parameter
 from . import ir_http
+from . import ir_mail_server
 from . import ir_model
 from . import ir_model_fields
 from . import ir_translation

--- a/addons/mail/models/fetchmail.py
+++ b/addons/mail/models/fetchmail.py
@@ -114,8 +114,14 @@ odoo_mailgate: "|/path/to/odoo-mailgate.py --host=localhost -u %(uid)d -p PASSWO
         self.write({'state': 'draft'})
         return True
 
-    def connect(self):
+    def connect(self, allow_archived=False):
+        """
+        :param bool allow_archived: by default (False), an exception is raised when calling this method on an
+           archived record. It can be set to True for testing so that the exception is no longer raised.
+        """
         self.ensure_one()
+        if not allow_archived and not self.active:
+            raise UserError(_('The server "%s" cannot be used because it is archived.', self.display_name))
         connection_type = self._get_connection_type()
         if connection_type == 'imap':
             if self.is_ssl:
@@ -147,7 +153,7 @@ odoo_mailgate: "|/path/to/odoo-mailgate.py --host=localhost -u %(uid)d -p PASSWO
     def button_confirm_login(self):
         for server in self:
             try:
-                connection = server.connect()
+                connection = server.connect(allow_archived=True)
                 server.write({'state': 'done'})
             except UnicodeError as e:
                 raise UserError(_("Invalid server name !\n %s", tools.ustr(e)))

--- a/None
+++ b/addons/mail/models/ir_mail_server.py
@@ -0,0 +1,23 @@
+# -*- coding: utf-8 -*-
+# Part of Odoo. See LICENSE file for full copyright and licensing details.
+
+from odoo import _, fields, models
+
+
+class IrMailServer(models.Model):
+    _name = 'ir.mail_server'
+    _inherit = ['ir.mail_server']
+
+    mail_template_ids = fields.One2many(
+        comodel_name='mail.template',
+        inverse_name='mail_server_id',
+        string='Mail template using this mail server',
+        readonly=True)
+
+    def _active_usages_compute(self):
+        usages_super = super()._active_usages_compute()
+        for record in self.filtered('mail_template_ids'):
+            usages_super.setdefault(record.id, []).extend(
+                map(lambda t: _('%s (Email Template)', t.display_name), record.mail_template_ids)
+            )
+        return usages_super
