PR: https://github.com/odoo/odoo/pull/

From: 3ec6294739d19e2c263c270b49483199121a02c0
From: SÃ©bastien Theys
Date: 2018-07-17 09:50:35

Structural Changes: 6
Total Changes: 39

[IMP] account,sale: move B2B/B2C setting into account

Since sale depends on account and not the other way around, it's better to have this setting inside account.

Functionally it will allow the user to benefit from this setting also if he uses only invoice without sale.

Technically it will allow us to remove all of the overrides that were previously necessary for this setting.

While we moved the setting, we also renamed the different variables so their name better convey their meaning.

PR #25209

================================= pseudo patch: =================================

--- a/addons/account/models/res_config_settings.py
+++ b/addons/account/models/res_config_settings.py
@@ -32,6 +32,22 @@ class ResConfigSettings(models.TransientModel):
     group_warning_account = fields.Boolean(string="Warnings in Invoices", implied_group='account.group_warning_account')
     group_cash_rounding = fields.Boolean(string="Cash Rounding", implied_group='account.group_cash_rounding')
     group_fiscal_year = fields.Boolean(string='Fiscal Years', implied_group='account.group_fiscal_year')
+    # group_show_line_subtotals_tax_excluded and group_show_line_subtotals_tax_included are opposite,
+    # so we can assume exactly one of them will be set, and not the other.
+    # We need both of them to coexist so we can take advantage of automatic group assignation.
+    group_show_line_subtotals_tax_excluded = fields.Boolean(
+        "Show line subtotals without taxes (B2B)",
+        implied_group='account.group_show_line_subtotals_tax_excluded',
+        group='base.group_portal,base.group_user,base.group_public')
+    group_show_line_subtotals_tax_included = fields.Boolean(
+        "Show line subtotals with taxes (B2C)",
+        implied_group='account.group_show_line_subtotals_tax_included',
+        group='base.group_portal,base.group_user,base.group_public')
+    show_line_subtotals_tax_selection = fields.Selection([
+        ('tax_excluded', 'Tax-Excluded'),
+        ('tax_included', 'Tax-Included')], string="Line Subtotals Tax Display",
+        required=True, default='tax_excluded',
+        config_parameter='account.show_line_subtotals_tax_selection')
     module_account_asset = fields.Boolean(string='Assets Management')
     module_account_deferred_revenue = fields.Boolean(string="Revenue Recognition")
     module_account_budget = fields.Boolean(string='Budget Management')
@@ -88,6 +104,19 @@ class ResConfigSettings(models.TransientModel):
         self.chart_template_id = self.company_id.chart_template_id or False
         self.has_accounting_entries = self.env['wizard.multi.charts.accounts'].existing_accounting(self.company_id)
 
+    @api.onchange('show_line_subtotals_tax_selection')
+    def _onchange_sale_tax(self):
+        if self.show_line_subtotals_tax_selection == "tax_excluded":
+            self.update({
+                'group_show_line_subtotals_tax_included': False,
+                'group_show_line_subtotals_tax_excluded': True,
+            })
+        else:
+            self.update({
+                'group_show_line_subtotals_tax_included': True,
+                'group_show_line_subtotals_tax_excluded': False,
+            })
+
     @api.onchange('group_analytic_accounting')
     def onchange_analytic_accounting(self):
         if self.group_analytic_accounting:

--- a/addons/account/models/res_users.py
+++ b/addons/account/models/res_users.py
@@ -7,6 +7,16 @@ from odoo import fields, models
 class ResUsers(models.Model):
     _inherit = 'res.users'
 
+    has_group_show_line_subtotals_tax_excluded = fields.Boolean(
+        "Show line subtotals without taxes (B2B)",
+        compute='_compute_groups_id', inverse='_inverse_groups_id',
+        group_xml_id='account.group_show_line_subtotals_tax_excluded')
+
+    has_group_show_line_subtotals_tax_included = fields.Boolean(
+        "Show line subtotals with taxes included (B2C)",
+        compute='_compute_groups_id', inverse='_inverse_groups_id',
+        group_xml_id='account.group_show_line_subtotals_tax_included')
+
     has_group_warning_account = fields.Boolean(
         'A warning can be set on a partner (Account)', compute='_compute_groups_id', inverse='_inverse_groups_id',
         group_xml_id='account.group_warning_account')
